<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LexiLab - Advanced Text Analytics</title>
<link rel="icon" href="https://files.catbox.moe/112ntw.png" type="image/png">
<meta name="description" content="Advanced word counter with PDF, OCR, reading time, voice reader and export. Every Word Counts.">
<meta name="keywords" content="word counter, character counter, pdf counter, reading time">
<meta name="author" content="LexiLab">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<link rel="manifest" href="manifest.json">
<style>
:root{
    --bg: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #f5576c 75%, #4facfe 100%);
    --card: rgba(255, 255, 255, 0.95);
    --text: #1a202c;
    --border: rgba(203, 213, 224, 0.6);
    --btn: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --secondary-btn: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
}

body.dark {
    --bg: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #475569 75%, #64748b 100%);
    --card: rgba(30, 41, 59, 0.95);
    --text: #f1f5f9;
    --border: rgba(71, 85, 105, 0.6);
    --btn: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --secondary-btn: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    --shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

*{
    box-sizing:border-box;
    font-family:'Inter',system-ui;
    margin:0;
    padding:0;
}

body{
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    transition: background 0.5s ease;
    background-size: 400% 400%;
    animation: gradientShift 15s ease infinite;
}

@keyframes gradientShift {
    0% { background-position: 0% 50% }
    50% { background-position: 100% 50% }
    100% { background-position: 0% 50% }
}

.container{
    max-width:1400px;
    margin:auto;
    padding:20px;
    position: relative;
    z-index: 1;
}

header{
    text-align:center;
    margin-bottom:30px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:15px;
    flex-wrap:wrap;
    background: var(--card);
    border-radius: 24px;
    padding: 20px;
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow);
}

.logo{
    font-size:42px;
    font-weight:800;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
    display:flex;
    align-items:center;
    gap:10px;
}

.logo::before{
    content:"";
    display:inline-block;
    width:40px;
    height:40px;
    background-image:url('https://files.catbox.moe/112ntw.png');
    background-size:contain;
    background-repeat:no-repeat;
    background-position:center;
}

body.dark .logo {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
}

.slogan{
    font-size:16px;
    opacity:.7;
    margin-top:5px;
    text-align:center;
    width:100%;
}

.card{
    background: var(--card);
    border-radius:24px;
    padding:24px;
    box-shadow: var(--shadow);
    margin-bottom:20px;
    backdrop-filter: blur(10px);
    border: 1px solid var(--border);
}

textarea{
    width:100%;
    min-height:260px;
    background: rgba(255, 255, 255, 0.1);
    color: var(--text);
    border: 2px solid var(--border);
    border-radius:18px;
    padding:18px;
    font-size:15px;
    resize:vertical;
    transition: all 0.3s ease;
}

textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
}

textarea::selection{
    background: #667eea;
    color:white;
}

.controls{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    margin:18px 0;
}

button, label, select{
    background: var(--btn);
    border:none;
    border-radius:16px;
    padding:12px 20px;
    color:white;
    font-weight:600;
    cursor:pointer;
    transition: all 0.3s ease;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    text-decoration: none;
}

button:hover, label:hover, select:hover{
    transform:translateY(-3px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}

button.secondary{
    background: var(--secondary-btn);
    border: none;
    color:white;
}

input[type=file]{
    display:none;
}

select{
    background: var(--btn);
    border: none;
    color:white;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 16px;
    padding-right: 45px;
}

.stats{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(190px,1fr));
    gap:16px;
}

.stat{
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid var(--border);
    border-radius:18px;
    padding:16px;
    text-align:center;
    backdrop-filter: blur(5px);
    transition: all 0.3s ease;
}

.stat:hover {
    transform: translateY(-5px);
    border-color: #667eea;
}

.stat h2{
    margin:0;
    font-size:28px;
    font-weight:800;
    background: var(--btn);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
}

.stat span{
    font-size:13px;
    opacity:.7;
}

.panel{
    margin-top:20px;
    background: var(--card);
    border: 2px solid var(--border);
    border-radius:18px;
    padding:16px;
    backdrop-filter: blur(10px);
}

.tab-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.tab-button {
    background: var(--border);
    border: none;
    border-radius: 12px;
    padding: 10px 20px;
    color: var(--text);
    cursor: pointer;
    transition: all 0.3s ease;
}

.tab-button.active {
    background: var(--btn);
    color: white;
}

.tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.grammar-error {
    background: rgba(239, 68, 68, 0.2);
    border-left: 4px solid #ef4444;
    padding: 8px 12px;
    margin: 8px 0;
    border-radius: 4px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.8; }
    100% { opacity: 1; }
}

.summary-box {
    background: rgba(59, 130, 246, 0.1);
    border: 2px solid #3b82f6;
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
}

footer{
    text-align:center;
    margin-top:36px;
    opacity:.6;
    font-size:13px;
    display:flex;
    justify-content:center;
    gap:20px;
    flex-wrap:wrap;
}

.visits-counter{
    background: var(--card);
    border: 2px solid var(--border);
    border-radius:12px;
    padding:8px 16px;
    font-size:14px;
    backdrop-filter: blur(10px);
}

.highlight{
    background:rgba(37,99,235,0.2);
    border-radius:4px;
    padding:2px 0;
}

/* Responsive design */
@media (max-width: 768px) {
    .container{padding:15px}
    header h1{font-size:32px}
    .logo{font-size:32px}
    .logo::before{width:32px;height:32px}
    .controls{flex-direction:column;align-items:stretch}
    button,label,select{width:100%;text-align:center}
    .stats{grid-template-columns:repeat(2,1fr)}
    footer{flex-direction:column;gap:10px}
}
@media (max-width: 480px) {
    .container{padding:10px}
    .card{padding:16px}
    .stats{grid-template-columns:1fr}
    .stat h2{font-size:24px}
    textarea{min-height:200px}
    .logo{font-size:28px}
    .logo::before{width:28px;height:28px}
}
</style>
</head>
<body>
<div class="container" id="captureArea">
<header>
    <div class="logo">LexiLab</div>
    <div class="slogan">Every Word Counts</div>
</header>
<div class="card">
<textarea id="textInput" placeholder="Paste or type text here..."></textarea>
<div class="controls">
<button onclick="clearText()">Clear</button>
<label for="fileInput" id="fileLabel">Upload PDF / Image</label>
<input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg" onchange="handleFileUpload()">
<select id="readerSpeed"><option value="150">Slow</option><option value="200" selected>Normal</option><option value="300">Fast</option></select>
<button class="secondary" onclick="exportImage()">Export Screenshot</button>
<button class="secondary" id="speechBtn" onclick="toggleSpeech()">Read Aloud</button>
<button class="secondary" onclick="toggleTheme()">Toggle Theme</button>
<button class="secondary" onclick="highlightLongestSentence()">Highlight Longest</button>
<button class="secondary" onclick="checkGrammar()">Grammar Check</button>
<button class="secondary" onclick="generateSummary()">Summarize Text</button>
</div>
<div class="stats">
<div class="stat"><h2 id="words">0</h2><span>Words</span></div>
<div class="stat"><h2 id="sentences">0</h2><span>Sentences</span></div>
<div class="stat"><h2 id="characters">0</h2><span>Characters</span></div>
<div class="stat"><h2 id="charactersNoSpace">0</h2><span>No-space Characters</span></div>
<div class="stat"><h2 id="paragraphs">0</h2><span>Paragraphs</span></div>
<div class="stat"><h2 id="pages">0</h2><span>Estimated Pages</span></div>
<div class="stat"><h2 id="readingTime">0 min</h2><span>Reading Time</span></div>
<div class="stat"><h2 id="pdfPages">0</h2><span>PDF Pages</span></div>
</div>

<div class="panel">
    <div class="tab-buttons">
        <button class="tab-button active" onclick="switchTab('analysis')">Analysis</button>
        <button class="tab-button" onclick="switchTab('grammar')">Grammar Check</button>
        <button class="tab-button" onclick="switchTab('summary')">Text Summary</button>
    </div>
    
    <div id="analysisTab" class="tab-content active">
        <div id="analysisBox"></div>
    </div>
    
    <div id="grammarTab" class="tab-content">
        <div id="grammarResults">
            <p>Click "Grammar Check" to analyze your text for errors.</p>
        </div>
    </div>
    
    <div id="summaryTab" class="tab-content">
        <div id="summaryResults">
            <p>Click "Summarize Text" to generate a concise summary.</p>
        </div>
    </div>
</div>
</div>
<footer>
    <div>LexiLab • Every Word Counts • PWA ready</div>
    <div class="visits-counter">Visits: <span id="visitCount">0</span></div>
</footer>
</div>
<script>
// Initialize visit counter
let visitCount = localStorage.getItem('visitCount') || 0;
visitCount = parseInt(visitCount) + 1;
localStorage.setItem('visitCount', visitCount);
document.getElementById('visitCount').textContent = visitCount;

const textInput = document.getElementById('textInput')
const readerSpeed = document.getElementById('readerSpeed')
const speechBtn = document.getElementById('speechBtn')
const fileLabel = document.getElementById('fileLabel')
const fileInput = document.getElementById('fileInput')
let uploadedPdfPages = 0
let speaking = false
let currentAudio = null
let fileUploaded = false
let longestSentence = ''

// ElevenLabs API Configuration
const API_KEY = "sk_6a147f065aa760930d817b1c84fcf9fc53374920f6264b6a"
const VOICE_ID = "6FiCmD8eY5VyjOdG5Zjk"

// Set theme based on time
function setThemeByTime() {
    const now = new Date();
    const currentHour = now.getHours();
    
    // If time is between 7 AM and 9 PM, use light mode, otherwise dark mode
    if (currentHour >= 7 && currentHour < 21) {
        document.body.classList.remove('dark');
        localStorage.setItem('theme', 'light');
    } else {
        document.body.classList.add('dark');
        localStorage.setItem('theme', 'dark');
    }
}

// Check for saved theme preference
const savedTheme = localStorage.getItem('theme');
if (savedTheme) {
    if (savedTheme === 'dark') {
        document.body.classList.add('dark');
    } else {
        document.body.classList.remove('dark');
    }
} else {
    setThemeByTime();
}

// Update theme every minute to catch time changes
setInterval(setThemeByTime, 60000);

// autosave
textInput.value = localStorage.getItem('savedText') || ''

function detectLang() {
    const t = textInput.value;
    if (/[ğüşöçıİ]/i.test(t)) return 'tr-TR';
    if (/[а-яА-Я]/.test(t)) return 'ru-RU';
    return 'en-US';
}

function updateCounts() {
    const text = textInput.value
    localStorage.setItem('savedText', text)
    const wordsArr = text.trim() ? text.trim().split(/\s+/) : []
    const wordsCount = wordsArr.length
    const sentenceArr = text.split(/[.!?]+/).filter(s => s.trim())
    const sentenceCount = sentenceArr.length
    const charCount = text.length
    const charNoSpace = text.replace(/\s/g, '').length
    const paraCount = text.split(/\n+/).filter(p => p.trim()).length
    const pageCount = wordsCount ? Math.ceil(wordsCount / 250) : 0
    
    // More precise reading time calculation
    const wpm = parseInt(readerSpeed.value)
    const totalSeconds = wordsCount ? (wordsCount / wpm) * 60 : 0
    const minutes = Math.floor(totalSeconds / 60)
    const seconds = Math.floor(totalSeconds % 60)
    
    // Format reading time display
    let readingTimeDisplay = ''
    if (wordsCount === 0) {
        readingTimeDisplay = '0 min'
    } else if (minutes === 0) {
        readingTimeDisplay = seconds + ' sec'
    } else if (seconds === 0) {
        readingTimeDisplay = minutes + ' min'
    } else {
        readingTimeDisplay = minutes + ' min ' + seconds + ' sec'
    }
    
    // Find longest sentence
    longestSentence = ''
    sentenceArr.forEach(s => {
        if (s.length > longestSentence.length) longestSentence = s
    })
    
    words.textContent = wordsCount
    sentences.textContent = sentenceCount
    characters.textContent = charCount
    charactersNoSpace.textContent = charNoSpace
    paragraphs.textContent = paraCount
    pages.textContent = pageCount
    readingTime.textContent = readingTimeDisplay
    pdfPages.textContent = uploadedPdfPages
    analysisBox.innerHTML = '<b>Longest sentence:</b> ' + (longestSentence.substring(0, 100) + (longestSentence.length > 100 ? '...' : '') || '-')
}

textInput.addEventListener('input', updateCounts)
readerSpeed.addEventListener('change', updateCounts)

function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab and activate button
    document.getElementById(tabName + 'Tab').classList.add('active');
    event.target.classList.add('active');
}

function clearText() {
    textInput.value = '';
    uploadedPdfPages = 0;
    fileUploaded = false;
    fileLabel.textContent = 'Upload PDF / Image';
    fileLabel.style.opacity = '1';
    fileInput.disabled = false;
    updateCounts();
    stopSpeech();
    // Clear grammar and summary results
    document.getElementById('grammarResults').innerHTML = '<p>Click "Grammar Check" to analyze your text for errors.</p>';
    document.getElementById('summaryResults').innerHTML = '<p>Click "Summarize Text" to generate a concise summary.</p>';
}

function handleFileUpload() {
    if (fileUploaded) {
        alert('File already uploaded. Please clear text to upload a new file.');
        fileInput.value = '';
        return;
    }
    
    const file = fileInput.files[0];
    if (!file) return;
    
    fileUploaded = true;
    fileLabel.textContent = '✓ File Uploaded';
    fileLabel.style.opacity = '0.7';
    fileInput.disabled = true;
    
    if (file.type === 'application/pdf') {
        const reader = new FileReader();
        reader.onload = async () => {
            try {
                const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(reader.result) }).promise;
                uploadedPdfPages = pdf.numPages;
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    fullText += content.items.map(it => it.str).join(' ') + '\n';
                }
                textInput.value = fullText;
                updateCounts();
            } catch (error) {
                alert('Error reading PDF file. Please try again.');
                fileUploaded = false;
                fileLabel.textContent = 'Upload PDF / Image';
                fileLabel.style.opacity = '1';
                fileInput.disabled = false;
            }
        };
        reader.readAsArrayBuffer(file);
    } else {
        Tesseract.recognize(file, 'eng')
            .then(result => {
                textInput.value = result.data.text;
                updateCounts();
            })
            .catch(error => {
                alert('Error reading image file. Please try again.');
                fileUploaded = false;
                fileLabel.textContent = 'Upload PDF / Image';
                fileLabel.style.opacity = '1';
                fileInput.disabled = false;
            });
    }
}

function checkGrammar() {
    const text = textInput.value.trim();
    if (!text) {
        alert('Please enter some text to check grammar.');
        return;
    }
    
    // Switch to grammar tab
    switchTab('grammar');
    
    // Simple grammar checking rules (in a real app, use an API like LanguageTool)
    const grammarErrors = [];
    
    // Check for common errors
    if (text.includes(' alot ')) {
        grammarErrors.push({
            error: 'Use "a lot" instead of "alot"',
            suggestion: 'a lot'
        });
    }
    
    if (text.includes(' its ') && text.includes(' it\'s ')) {
        // Check for incorrect its/it's usage
        const sentences = text.split(/[.!?]+/);
        sentences.forEach((sentence, index) => {
            if (sentence.includes(' its ') && sentence.includes(' it is ')) {
                grammarErrors.push({
                    error: 'Possible incorrect "its" usage in sentence ' + (index + 1),
                    suggestion: 'Check if you mean "it\'s" (it is)'
                });
            }
        });
    }
    
    // Check for double spaces
    if (text.includes('  ')) {
        grammarErrors.push({
            error: 'Double spaces detected',
            suggestion: 'Use single spaces between words'
        });
    }
    
    // Check for sentence capitalization
    const sentences = text.split(/[.!?]+/);
    sentences.forEach((sentence, index) => {
        const trimmed = sentence.trim();
        if (trimmed && trimmed.length > 0) {
            const firstChar = trimmed.charAt(0);
            if (firstChar === firstChar.toLowerCase() && /[a-z]/.test(firstChar)) {
                grammarErrors.push({
                    error: 'Sentence ' + (index + 1) + ' should start with capital letter',
                    suggestion: 'Capitalize the first letter: ' + firstChar.toUpperCase()
                });
            }
        }
    });
    
    // Display results
    const grammarResults = document.getElementById('grammarResults');
    if (grammarErrors.length === 0) {
        grammarResults.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 48px; color: #10b981;">✓</div>
                <h3>Great! No grammar errors found</h3>
                <p>Your text looks good!</p>
            </div>
        `;
    } else {
        let html = `<h3>Found ${grammarErrors.length} potential issue${grammarErrors.length > 1 ? 's' : ''}:</h3>`;
        grammarErrors.forEach((error, index) => {
            html += `
                <div class="grammar-error">
                    <strong>Issue ${index + 1}:</strong> ${error.error}<br>
                    <strong>Suggestion:</strong> ${error.suggestion}
                </div>
            `;
        });
        grammarResults.innerHTML = html;
    }
}

function generateSummary() {
    const text = textInput.value.trim();
    if (!text) {
        alert('Please enter some text to summarize.');
        return;
    }
    
    // Switch to summary tab
    switchTab('summary');
    
    // Simple text summarization
    const sentences = text.split(/[.!?]+/).filter(s => s.trim());
    const words = text.trim().split(/\s+/);
    
    if (sentences.length <= 3 || words.length < 50) {
        document.getElementById('summaryResults').innerHTML = `
            <div class="summary-box">
                <h3>Text Summary</h3>
                <p>Text is too short for summarization. Here's your original text:</p>
                <p><em>"${text.substring(0, 200)}${text.length > 200 ? '...' : ''}"</em></p>
            </div>
        `;
        return;
    }
    
    // Create a simple summary (take first, middle, and last sentences)
    const summarySentences = [
        sentences[0],
        sentences[Math.floor(sentences.length / 2)],
        sentences[sentences.length - 1]
    ];
    
    const summary = summarySentences.join('. ') + '.';
    const reduction = Math.round((1 - (summary.length / text.length)) * 100);
    
    document.getElementById('summaryResults').innerHTML = `
        <div class="summary-box">
            <h3>Text Summary</h3>
            <p><strong>Original length:</strong> ${words.length} words, ${text.length} characters</p>
            <p><strong>Summary length:</strong> ${summary.split(/\s+/).length} words, ${summary.length} characters</p>
            <p><strong>Reduction:</strong> ${reduction}% shorter</p>
            <hr style="margin: 15px 0; border-color: var(--border);">
            <h4>Summary:</h4>
            <p>"${summary}"</p>
            <button onclick="copyToClipboard('${summary.replace(/'/g, "\\'")}')" 
                    style="margin-top: 10px; padding: 8px 16px; background: var(--btn); color: white; border: none; border-radius: 8px; cursor: pointer;">
                Copy Summary
            </button>
        </div>
    `;
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('Summary copied to clipboard!');
    });
}

async function toggleSpeech() {
    if (speaking) {
        stopSpeech();
        return;
    }
    
    const text = textInput.value.trim();
    if (!text) {
        alert('Please enter some text to read aloud');
        return;
    }
    
    try {
        speaking = true;
        speechBtn.textContent = 'Stop Reading';
        
        const response = await fetch(
            `https://api.elevenlabs.io/v1/text-to-speech/${VOICE_ID}`,
            {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "xi-api-key": API_KEY
                },
                body: JSON.stringify({
                    text: text,
                    model_id: "eleven_multilingual_v2",
                    voice_settings: {
                        stability: 0.5,
                        similarity_boost: 0.7
                    }
                })
            }
        );

        if (!response.ok) {
            throw new Error(`API Error: ${response.status} ${response.statusText}`);
        }

        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        
        currentAudio = new Audio(audioUrl);
        currentAudio.play();
        
        currentAudio.onended = () => {
            speaking = false;
            speechBtn.textContent = 'Read Aloud';
            URL.revokeObjectURL(audioUrl);
        };
        
        currentAudio.onerror = (err) => {
            console.error('Audio playback error:', err);
            speaking = false;
            speechBtn.textContent = 'Read Aloud';
            alert('Error playing audio. Please try again.');
            URL.revokeObjectURL(audioUrl);
        };
        
    } catch (error) {
        console.error('Speech generation error:', error);
        speaking = false;
        speechBtn.textContent = 'Read Aloud';
        
        // Fallback to browser speech synthesis
        alert('ElevenLabs API error. Using browser speech synthesis instead.');
        useBrowserSpeechSynthesis(text);
    }
}

function useBrowserSpeechSynthesis(text) {
    if (speaking) {
        speechSynthesis.cancel();
        speaking = false;
        speechBtn.textContent = 'Read Aloud';
        return;
    }
    
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = detectLang();
    
    utterance.onend = () => {
        speaking = false;
        speechBtn.textContent = 'Read Aloud';
    };
    
    utterance.onerror = () => {
        speaking = false;
        speechBtn.textContent = 'Read Aloud';
        alert('Speech synthesis failed. Please try again.');
    };
    
    speechSynthesis.speak(utterance);
    speaking = true;
    speechBtn.textContent = 'Stop Reading';
}

function stopSpeech() {
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
    }
    if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
    }
    speaking = false;
    speechBtn.textContent = 'Read Aloud';
}

function exportImage() {
    html2canvas(document.getElementById('captureArea')).then(canvas => {
        const a = document.createElement('a')
        a.href = canvas.toDataURL('image/png')
        a.download = 'lexilab-stats.png'
        a.click()
    })
}

function toggleTheme() {
    const isDark = document.body.classList.toggle('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
}

function highlightLongestSentence() {
    if (!longestSentence) {
        alert('No text found to highlight.');
        return;
    }
    
    const text = textInput.value;
    const startIndex = text.indexOf(longestSentence);
    
    if (startIndex === -1) {
        alert('Could not find the longest sentence in the text.');
        return;
    }
    
    // Scroll to and highlight the longest sentence
    textInput.focus();
    textInput.setSelectionRange(startIndex, startIndex + longestSentence.length);
    
    // Add visual highlight
    const highlightedText = text.substring(0, startIndex) + 
                          '<span class="highlight">' + longestSentence + '</span>' + 
                          text.substring(startIndex + longestSentence.length);
    
    // Create a temporary element to show highlight
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = '<b>Longest sentence highlighted:</b><br>' + 
                       highlightedText.replace(/\n/g, '<br>');
    tempDiv.style.background = 'var(--card)';
    tempDiv.style.padding = '15px';
    tempDiv.style.borderRadius = '10px';
    tempDiv.style.marginTop = '10px';
    tempDiv.style.border = '1px solid var(--border)';
    
    // Remove previous highlight display
    const oldHighlight = document.getElementById('highlightDisplay');
    if (oldHighlight) oldHighlight.remove();
    
    tempDiv.id = 'highlightDisplay';
    analysisBox.parentNode.insertBefore(tempDiv, analysisBox.nextSibling);
    
    // Auto-remove highlight after 5 seconds
    setTimeout(() => {
        const highlight = document.getElementById('highlightDisplay');
        if (highlight) highlight.remove();
    }, 5000);
}

updateCounts()

// PWA install
let deferredPrompt
window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;
    setTimeout(() => {
        if (confirm('Install LexiLab as app?')) {
            deferredPrompt.prompt()
        }
    }, 2000)
})
</script>
</body>
</html>
